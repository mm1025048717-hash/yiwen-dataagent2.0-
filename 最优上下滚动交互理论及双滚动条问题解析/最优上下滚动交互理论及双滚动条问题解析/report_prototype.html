<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ChatBI 报表页 - 单主轴滚动演示（React + AntD）</title>
    <link rel="stylesheet" href="https://unpkg.com/antd@4.24.15/dist/antd.min.css" />
    <style>
      :root{
        --primary: #2a6df4;
        --primary-600: #1f57c8;
        --bg: #ffffff;
        --bg-soft: #f6f8fc;
        --text: #0b1220;
        --muted: #5b6476;
        --border: #e6ebf5;
        --top-h: 64px;      /* JS 动态设定：桌面 64，移动 56 */
        --filters-h: 48px;  /* 固定 */
        --sticky-offset: 112px; /* = top + filters */
      }
      html { overscroll-behavior-y: contain; scroll-behavior: smooth; }
      body { margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'PingFang SC', 'Microsoft YaHei', sans-serif; color:var(--text); background:var(--bg); }

      .top {
        position: sticky; top: 0; z-index: 1000;
        height: var(--top-h);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 16px; border-bottom:1px solid var(--border);
        background: rgba(255,255,255,0.9); backdrop-filter: saturate(180%) blur(10px);
      }
      .filters {
        position: sticky; top: var(--top-h); z-index: 999;
        height: var(--filters-h);
        display: flex; gap: 8px; align-items: center;
        padding: 0 16px; border-bottom:1px solid var(--border); background: var(--bg);
      }
      .container { max-width: 1200px; margin: 0 auto; padding: 16px; }

      .section { margin-top: 16px; border:1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--bg); }
      .section-head { padding: 12px 16px; border-bottom:1px solid var(--border); background: var(--bg-soft); font-weight: 600; display:flex; align-items:center; justify-content: space-between; }
      .section-body { padding: 12px 16px; }

      /* 表格：仅横向滚动；用 mask 提示左右可拖 */
      .h-mask .ant-table-container {
        -webkit-mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
        mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
      }
      /* 让根仅纵向滚；表格不创建第二个纵向滚容器（不设置 scroll.y） */

      .fab {
        position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom)); z-index: 1100;
        transition: transform .25s ease, opacity .25s ease; opacity: 1; transform: translateY(0);
      }
      .fab.hide { opacity: 0; transform: translateY(16px); pointer-events: none; }

      /* Bottom Sheet */
      .sheet-backdrop { position: fixed; inset: 0; background: rgba(13,18,32,.42); z-index: 1300; display: none; }
      .sheet-backdrop.open { display: block; }
      .sheet {
        position: fixed; left: 0; right: 0; bottom: 0; z-index: 1301; display: none;
        background: #fff; border-radius: 12px 12px 0 0; border: 1px solid var(--border);
        box-shadow: 0 -12px 32px rgba(0,0,0,.1);
        transform: translateY(100%); transition: transform .25s ease;
        max-height: min(80dvh, 560px); overflow: auto; overscroll-behavior: contain;
      }
      .sheet.open { display: block; transform: translateY(0); }
      .sheet-head { position: sticky; top:0; background: var(--bg-soft); border-bottom:1px solid var(--border); padding: 12px 16px; display:flex; align-items:center; justify-content: space-between; }
      .sheet-body { padding: 12px 16px; }
      .sheet-footer { position: sticky; bottom: 0; background: #fff; border-top: 1px solid var(--border); padding: 12px 16px calc(12px + env(safe-area-inset-bottom)); display:flex; gap: 8px; justify-content: flex-end; }
      .grabber { width: 36px; height: 4px; border-radius: 999px; background: #cfd6e6; margin-right: 8px; }

      /* body 锁定（Bottom Sheet 打开时） */
      body.modal-open { position: fixed; width: 100%; overflow: hidden; }

      /* 简易卡片视图 */
      .card-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap: 12px; }
      .card { border:1px solid var(--border); border-radius: 10px; padding: 12px; background:#fff; }
      .card .title { font-weight: 600; margin-bottom: 8px; }
      .metric { display:flex; justify-content: space-between; margin: 6px 0; }
      .text-weak { color: #6b7280; }
      .text-danger { color: #b91c1c; }
      .text-ok { color: #166534; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <div class="sheet-backdrop" id="sheetBackdrop"></div>
    <div class="sheet" id="bottomSheet" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="sheet-head">
        <div style="display:flex; align-items:center; gap:8px;">
          <div class="grabber" aria-hidden="true"></div>
          <div>更多筛选</div>
        </div>
        <button id="closeSheet" class="ant-btn"><span>关闭</span></button>
      </div>
      <div class="sheet-body">
        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:12px;">
          <div>
            <div class="text-weak">日期</div>
            <input class="ant-input" placeholder="2024-01~2024-12" />
          </div>
          <div>
            <div class="text-weak">事业部</div>
            <input class="ant-input" placeholder="选择事业部" />
          </div>
          <div>
            <div class="text-weak">企业</div>
            <input class="ant-input" placeholder="输入企业名" />
          </div>
          <div>
            <div class="text-weak">分组</div>
            <input class="ant-input" placeholder="选择分组" />
          </div>
        </div>
      </div>
      <div class="sheet-footer">
        <button class="ant-btn" id="resetSheet"><span>重置</span></button>
        <button class="ant-btn ant-btn-primary" id="applySheet"><span>应用</span></button>
      </div>
    </div>

    <button id="fab" class="fab ant-btn ant-btn-primary"><span>导出/分享</span></button>

    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/antd@4.24.15/dist/antd.min.js"></script>
    <script>
      // 工具：Body Scroll Lock for Bottom Sheet
      (function(){
        const $sheet = document.getElementById('bottomSheet');
        const $backdrop = document.getElementById('sheetBackdrop');
        const $close = document.getElementById('closeSheet');
        const $reset = document.getElementById('resetSheet');
        const $apply = document.getElementById('applySheet');
        const $head = $sheet.querySelector('.sheet-head');
        let prevY = 0;
        function openSheet(){
          prevY = window.scrollY;
          document.body.style.top = `-${prevY}px`;
          document.body.classList.add('modal-open');
          $backdrop.classList.add('open');
          $sheet.classList.add('open');
          $sheet.setAttribute('aria-hidden', 'false');
          $sheet.style.transition = '';
          $sheet.style.transform = 'translateY(0)';
        }
        function closeSheet(){
          const top = parseInt(document.body.style.top || '0', 10);
          document.body.classList.remove('modal-open');
          document.body.style.top = '';
          window.scrollTo(0, Math.abs(top) || prevY || 0);
          $backdrop.classList.remove('open');
          $sheet.classList.remove('open');
          $sheet.setAttribute('aria-hidden', 'true');
          $sheet.style.transition = '';
          $sheet.style.transform = '';
        }
        window.__openSheet = openSheet;
        $backdrop.addEventListener('click', closeSheet);
        $close.addEventListener('click', closeSheet);
        $reset.addEventListener('click', function(){
          Array.from($sheet.querySelectorAll('input')).forEach(i => i.value = '');
        });
        $apply.addEventListener('click', closeSheet);

        // 手势：下拉关闭（仅在头部区域触发）
        let startY = 0, curY = 0, dragging = false;
        function onStart(e){ dragging = true; startY = (e.touches? e.touches[0]: e).clientY; $sheet.style.transition = 'none'; curY = startY; }
        function onMove(e){ if(!dragging) return; curY = (e.touches? e.touches[0]: e).clientY; const dy = Math.max(0, curY - startY); $sheet.style.transform = `translateY(${dy}px)`; $backdrop.style.opacity = String(Math.max(0.3, 1 - dy/300)); }
        function onEnd(){ if(!dragging) return; dragging = false; const dy = Math.max(0, curY - startY); $sheet.style.transition = 'transform .25s ease'; $backdrop.style.opacity = ''; if (dy > 120) { closeSheet(); } else { $sheet.style.transform = 'translateY(0)'; } }
        $head.addEventListener('touchstart', onStart, { passive: true });
        $head.addEventListener('touchmove', onMove, { passive: true });
        $head.addEventListener('touchend', onEnd);
        $head.addEventListener('mousedown', onStart);
        $head.addEventListener('mousemove', onMove);
        $head.addEventListener('mouseup', onEnd);
      })();

      // FAB 显隐（向下滚隐藏，向上滚显示）
      (function(){
        const $fab = document.getElementById('fab');
        let lastY = window.scrollY;
        window.addEventListener('scroll', function(){
          const y = window.scrollY;
          if (y > lastY + 4) { $fab.classList.add('hide'); }
          else if (y < lastY - 4) { $fab.classList.remove('hide'); }
          lastY = y;
        }, { passive: true });
      })();

      // React 应用
      (function(React, ReactDOM, antd){
        const { useMemo, useState, useEffect } = React;
        const { Table, Button, Radio, Space, Tag, message } = antd;

        function useResponsive(){
          const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
          useEffect(() => {
            const onResize = () => setIsMobile(window.innerWidth < 768);
            window.addEventListener('resize', onResize, { passive: true });
            return () => window.removeEventListener('resize', onResize);
          }, []);
          return isMobile;
        }

        function App(){
          const isMobile = useResponsive();
          const [view, setView] = useState(isMobile ? 'card' : 'table');

          useEffect(() => {
            // 同步 sticky 尺寸变量
            const top = isMobile ? 56 : 64; const filters = 48; const off = top + filters;
            document.documentElement.style.setProperty('--top-h', top + 'px');
            document.documentElement.style.setProperty('--filters-h', filters + 'px');
            document.documentElement.style.setProperty('--sticky-offset', off + 'px');
          }, [isMobile]);

          const data = useMemo(() => {
            const arr = [];
            const groups = ['一事业部', '二事业部', '三事业部'];
            for (let i = 0; i < 120; i++) {
              const g = groups[i % groups.length];
              arr.push({
                key: i,
                group: g,
                name: g + ' - 企业 ' + (i+1),
                penetration: Math.random() * 0.3,
                maint: Math.random() * 0.2,
                after: Math.random() * 0.2,
                cost: Math.round(1000 + Math.random()*9000),
              });
            }
            return arr;
          }, []);

          const columns = useMemo(() => {
            const nameColWidth = isMobile ? 170 : 200; // 缩小冻结列宽度
            const remarkWidth = isMobile ? 160 : 200;
            return [
              { title: '企业', dataIndex: 'name', key: 'name', fixed: 'left', width: nameColWidth, ellipsis: true },
              { title: '成本渗透率', dataIndex: 'penetration', key: 'penetration', align: 'right', width: 150,
                render: (v) => React.createElement('span', { className: v>0.15?'text-danger':(v<0.02?'text-weak':'text-ok') }, ((v*100).toFixed(2)+'%')) },
              { title: '维修渗透', dataIndex: 'maint', key: 'maint', align: 'right', width: 130, render: (v)=> (v*100).toFixed(1)+'%' },
              { title: '售后渗透', dataIndex: 'after', key: 'after', align: 'right', width: 130, render: (v)=> (v*100).toFixed(1)+'%' },
              { title: '成本(¥)', dataIndex: 'cost', key: 'cost', align: 'right', width: 150 },
              { title: '备注', key: 'tags', width: remarkWidth, render: ()=> React.createElement(Space, null,
                  React.createElement(Tag, { color: 'blue' }, '重点'),
                  React.createElement(Tag, null, '关注')
              ) },
            ];
          }, [isMobile]);

          // 简易分组小计：此处仅示意（真实项目可用 group header + sticky 处理）
          const grouped = useMemo(() => {
            const map = new Map();
            for (const row of data) { if (!map.has(row.group)) map.set(row.group, []); map.get(row.group).push(row); }
            return Array.from(map.entries());
          }, [data]);

          function TableSection(){
            return React.createElement('div', { className: 'section' },
              React.createElement('div', { className: 'section-head' },
                React.createElement('div', null, '事业部/企业分组报表（单主轴纵向 + 横向溢出）'),
                React.createElement(Space, null,
                  React.createElement(Button, { onClick: () => window.__openSheet && window.__openSheet() }, '更多筛选'),
                  React.createElement(Button, { type: 'primary', onClick: ()=> message.success('导出成功（示例）') }, '导出')
                )
              ),
              React.createElement('div', { className: 'section-body h-mask' },
                React.createElement(Table, {
                  size: 'small',
                  columns, dataSource: data, pagination: false,
                  sticky: { offsetHeader: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sticky-offset')) || 112 },
                  scroll: { x: 'max-content' },
                })
              )
            );
          }

          function CardSection(){
            return React.createElement('div', { className: 'section' },
              React.createElement('div', { className: 'section-head' },
                React.createElement('div', null, '卡片视图（移动端默认）'),
                React.createElement('div', { className: 'text-weak' }, '仅示例主要指标，支持分组折叠')
              ),
              React.createElement('div', { className: 'section-body' },
                React.createElement('div', { className: 'card-grid' },
                  grouped.map(([groupName, rows]) => (
                    React.createElement('div', { key: groupName },
                      React.createElement('div', { className: 'text-weak', style: { margin: '8px 0'} }, groupName + '（小计示意）'),
                      rows.slice(0, 6).map(row => (
                        React.createElement('div', { key: row.key, className: 'card' },
                          React.createElement('div', { className: 'title' }, row.name),
                          React.createElement('div', { className: 'metric' },
                            React.createElement('span', null, '成本渗透率'),
                            React.createElement('span', { className: row.penetration>0.15?'text-danger':(row.penetration<0.02?'text-weak':'text-ok') }, (row.penetration*100).toFixed(2)+'%')
                          ),
                          React.createElement('div', { className: 'metric' },
                            React.createElement('span', null, '维修渗透'),
                            React.createElement('span', null, (row.maint*100).toFixed(1)+'%')
                          ),
                          React.createElement('div', { className: 'metric' },
                            React.createElement('span', null, '售后渗透'),
                            React.createElement('span', null, (row.after*100).toFixed(1)+'%')
                          ),
                          React.createElement('div', { className: 'metric' },
                            React.createElement('span', null, '成本(¥)'),
                            React.createElement('span', null, row.cost)
                          )
                        )
                      ))
                    )
                  ))
                )
              )
            );
          }

          return React.createElement(React.Fragment, null,
            React.createElement('header', { className: 'top' },
              React.createElement('div', null, 'ChatBI 报表页（Demo）'),
              React.createElement(Space, null,
                React.createElement(Radio.Group, { value: view, onChange: e => setView(e.target.value) },
                  React.createElement(Radio.Button, { value: 'table' }, '表格'),
                  React.createElement(Radio.Button, { value: 'card' }, '卡片')
                )
              )
            ),
            React.createElement('div', { className: 'filters' },
              React.createElement(Space, { wrap: true },
                React.createElement(Button, { onClick: ()=> window.__openSheet && window.__openSheet() }, '更多筛选'),
                React.createElement(Button, { onClick: ()=> window.scrollTo({ top: 0, behavior:'smooth' }) }, '回到顶部')
              )
            ),
            React.createElement('main', { className: 'container' },
              view === 'table' ? React.createElement(TableSection) : React.createElement(CardSection)
            )
          );
        }

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
      })(React, ReactDOM, antd);
    </script>
  </body>
</html>


